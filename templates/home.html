<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fink的小窝 - 聊天小窗</title>
  <meta name="description" content="Fink的小窝 - 一个温馨可爱的实时聊天小站，支持注册、登录、消息互动。" />
  <!-- 设置网页图标（favicon） -->
  <link rel="icon" href="/static/icon.ico" type="image/x-icon" />
  <!-- 可选：社交分享图标（Open Graph） -->
  <meta property="og:title" content="Fink的小窝 - 聊天小窗" />
  <meta property="og:description" content="和朋友们一起窝在这里聊天吧！" />
  <meta property="og:image" content="/static/logo.webp" />
  <meta property="og:type" content="website" />
  <link rel="manifest" href="/static/manifest.json" />
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZK9F0GE4SE"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-ZK9F0GE4SE');
  </script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 0;
      height: 100vh;
      /* 占满全屏 */
      overflow: hidden;
      /* 防止滚动条 */
    }

    .container {
      width: 100%;
      max-width: 580px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 20px 16px 12px;
      box-shadow: none;
      border-radius: 10px;
      background: white;
      display: flex;
      flex-direction: column;
    }

    h1 {
      text-align: center;
      margin: 0 0 10px;
      color: #333;
      font-size: 22px;
    }

    #top-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    #load-more {
      flex: 1;
      padding: 6px 12px;
      font-size: 13px;
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
    }

    #load-more:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    #online-count-btn {
      flex: 1;
      padding: 6px 12px;
      font-size: 13px;
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
    }

    #logout {
      padding: 6px 7px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
    }

    #logout img {
      width: 18px;
      height: 18px;
      display: block;
    }

    #chat-box {
      flex: 1;
      overflow-y: auto;
      max-height: calc(100vh - 240px);
      /* 保证 chat-box 不被撑出去 */
      border: 1.5px solid #ccc;
      padding: 10px;
      background: #fafafa;
      border-radius: 6px;
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 8px;
      word-break: break-all;
    }

    #chat-input {
      display: flex;
      margin-bottom: 10px;
    }

    #chat-input input[type="text"] {
      flex: 1;
      padding: 10px;
      font-size: 14px;
      border: 1.5px solid #ccc;
      border-radius: 6px 0 0 6px;
      outline: none;
    }

    #chat-input button {
      padding: 10px 16px;
      background: #3b82f6;
      color: white;
      font-weight: 600;
      border: none;
      border-radius: 0 6px 6px 0;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #chat-input button:hover {
      background: #2563eb;
    }

    @media (max-width: 480px) {
      .container {
        height: 95vh;
        border-radius: 0;
        padding: 16px;
      }

      h1 {
        font-size: 18px;
      }

      #chat-box {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 8px;
      }
    }

    #footer {
      bottom: 0;
      left: 0;
      width: 100%;
      font-size: 13px;
      color: #888;
      background: #ffffff;
      text-align: center;
      padding: 12px 0;
      border-top: 1px solid #ffffff;
      z-index: 99;
    }

    #footer a {
      color: #3b82f6;
      text-decoration: none;
    }

    #footer a:hover {
      text-decoration: underline;
    }


    #announcement-modal button.confirm-btn {
      margin-top: 12px;
      padding: 6px 12px;
      border: none;
      background: #faad14;
      color: white;
      border-radius: 4px;
      font-size: 14px;
      width: 100%;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    #announcement-modal button.confirm-btn:hover {
      background: #d48806;
    }
  </style>
</head>

<body>
  <div class="container">



    <!-- 公告弹窗 -->
    <!-- 遮罩层 -->
    <div id="announcement-overlay" style="display: none; position: fixed; top: 0; left: 0;
width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.3); z-index: 998;">
      <div id="announcement-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
         z-index: 999; background: #fffbe6; border: 1px solid #ffe58f;
         padding: 20px 16px; width: 90%; max-width: 400px; border-radius: 8px;
         box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);">

        <div style="display: flex; justify-content: space-between; align-items: start;">
          <div>
            <strong id="announcement-title" style="color: #f2ae26; font-size: 16px;"></strong>
            <p id="announcement-content" style="margin: 6px 0 0; color: #333; font-size: 14px;white-space: pre-line;">
            </p>
          </div>
          <button onclick="closeAnnouncement()"
            style="background: none; border: none; font-weight: bold; cursor: pointer; font-size: 16px;">✕</button>
        </div>

        <button onclick="acknowledgeAnnouncement()" class="confirm-btn">我已知晓</button>
      </div>
    </div>


    <!-- 在线用户列表遮罩 -->
    <div id="online-overlay"
      style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:998;">
    </div>

    <!-- 在线用户列表弹窗 -->
    <div id="online-modal"
      style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
  z-index:999; background:#f7d6d6; border:1px solid #ccc; border-radius:8px; padding:16px 20px; max-width:300px; width:90%; box-shadow:0 10px 20px rgba(0,0,0,0.2);">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <strong style="font-size:16px; color:#333;">实时在线用户列表</strong>
        <button onclick="closeOnlineList()"
          style="background:none; border:none; font-size:16px; cursor:pointer;">✕</button>
      </div>
      <div id="online-user-list" style="margin-top:12px; font-size:14px; max-height:200px; overflow-y:auto;"></div>
    </div>





    <h1>
      欢迎
      <span id="username" style="font-weight: bold;">{{ username }}</span>
      来到Fink的小窝
    </h1>

    <div id="top-bar">
      <button id="load-more" onclick="loadMore()">加载更多历史信息</button>
      <button id="online-count-btn" onclick="openOnlineList()">当前在线人数：0</button>
      <button id="logout" onclick="logout()">
        <img src="/static/logout.svg" alt="退出" />
      </button>
    </div>

    <div id="chat-box"></div>
    <div id="chat-input">
      <input type="text" id="message" placeholder="输入消息..." />
      <button onclick="sendMessage()">发送</button>
    </div>

    <div id="footer">
      © 2025 Fink ·
      <a href="https://github.com/finkkk/fink_chat" target="_blank">开源地址</a>
      · {{ version }} · 更新:{{ updated }}
    </div>
  </div>

  <script>
    const knownUsernames = new Set(); // 所有已知用户名（用于判断 @谁 是否是有效用户）
    let socket = null;
    window.username = "{{ username }}"; // 当前登录用户名
    window.userRole = "{{ role }}"; // 当前用户权限角色
    const chatBox = document.getElementById("chat-box");
    const messageInput = document.getElementById("message");
    const loadMoreBtn = document.getElementById("load-more");
    let messageOffset = 0; // 当前历史消息加载偏移量
    const limitPerLoad = 10; // 每次最多加载多少条历史记录

    // 初始化 Socket.IO 并设置事件监听
    function initSocket() {
      socket = io({ withCredentials: true });

      // 处理连接逻辑
      socket.on("connect", () => {
        console.log("已连接到服务器");
        // 向后端绑定用户名和角色
        socket.emit("bind_username", { username: window.username, role: window.userRole });
      });

      // 接收历史消息（首次或点击“加载更多”）
      socket.on("chat_history", (messages) => {
        if (!messages || messages.length === 0) {
          loadMoreBtn.disabled = true;
          loadMoreBtn.textContent = "没有更多消息";
          return;
        }
        messages.reverse().forEach((msg) => appendMessage(msg, true));
        messageOffset += messages.length;
        if (messageOffset === messages.length) {
          chatBox.scrollTop = chatBox.scrollHeight;
        }
      });

      // 接收实时消息
      socket.on("receive_message", (data) => {
        appendMessage(data);
        playMentionSound(data);
      });

      // 更新显示在线用户列表人数
      socket.on("online_users", (userList) => {
        // 排除游客
        const filtered = userList.filter(u => u.role !== "guest");

        // 排序规则
        filtered.sort((a, b) => {
          const getPriority = (u) => {
            if (u.username === window.username) return 0;
            if (u.role === "super_admin") return 1;
            if (u.role === "admin") return 2;
            return 3; // 普通用户
          };
          return getPriority(a) - getPriority(b);
        });

        // 渲染
        const container = document.getElementById("online-user-list");
        container.innerHTML = filtered.map(({ username, role }) => {
          const isSelf = username === window.username;
          const label = isSelf ? "（你）" : "";

          let color = "#3b82f6"; // 普通用户字体色
          if (isSelf) color = "#10b981"; // 自己绿色
          else if (role === "super_admin") color = "red";
          else if (role === "admin") color = "orange";
          let badge = "";
          if (role === "super_admin") badge = "👑";
          else if (role === "admin") badge = "🎯";
          return `
            <div style="
              background: #f3f4f6;
              border-radius: 12px;
              padding: 10px 14px;
              margin-bottom: 10px;
              box-shadow: 0 2px 6px rgba(0,0,0,0.1);
              display: flex;
              align-items: center;
              justify-content: space-between;
              font-weight: 600;
              font-size: 15px;
              color: ${color};
              transition: transform 0.2s ease;
            "
            >
              <span>${username}${label}</span>
              <span style="font-size: 18px;">${badge}</span>
            </div>
          `;
        }).join("");

        // 更新按钮人数（包含游客在内的总数）
        const btn = document.getElementById("online-count-btn");
        btn.textContent = `当前在线人数：${userList.length}`;
      });
    }

    // 高亮消息中有效 @用户名 的文字
    function highlightMentions(msg) {
      return msg.replace(/@([\u4e00-\u9fa5\w\-]+)/g, (match, uname) => {
        if (knownUsernames.has(uname)) {
          return `<span style="color: #f472b6; font-weight: bold;">@${uname}</span>`;
        }
        return match;
      });
    }

    // 若消息中包含 @自己，则播放提示音
    function playMentionSound(data) {
      if (data.message && data.message.includes(`@${window.username}`)) {
        const audio = new Audio('/static/notify.mp3');
        audio.play().catch(() => { }); // 避免浏览器自动播放限制报错
      }
    }

    // 若消息中包含 @自己，则让该消息块背景短暂高亮
    function highlightIfMentioned(msgDiv, data) {
      if (data.message && data.message.includes(`@${window.username}`)) {
        msgDiv.style.transition = "background-color 0.8s ease";
        msgDiv.style.backgroundColor = "#ffe4ec";
        setTimeout(() => {
          msgDiv.style.backgroundColor = "transparent";
        }, 1500);
      }
    }

    // 渲染并插入单条消息，prepend=true 表示向上插入（历史记录）
    function appendMessage(data, prepend = false) {

      const msgDiv = document.createElement("div");

      // 将 ISO 格式时间转换成本地时间字符串
      let timeStr = "";
      if (data.timestamp) {
        try {
          const local = new Date(data.timestamp + "Z");
          timeStr = local.toLocaleString(undefined, {
            year: "numeric",
            month: "numeric",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
          });
        } catch { }
      }

      let nameColor = "#3b82f6";

      // 当前用户自己是超级管理员 → 红色
      if (data.username === window.username && window.userRole === "super_admin") {
        nameColor = "red";
      }
      // 当前用户自己是管理员 → 橙色
      else if (data.username === window.username && window.userRole === "admin") {
        nameColor = "orange";
      }

      // 如果发言者是超级管理员 → 红色
      else if (data.role === "super_admin") {
        nameColor = "red";
      }
      // 如果发言者是管理员 → 橙色
      else if (data.role === "admin") {
        nameColor = "orange";
      }

      // 身份徽章
      let badge = "";
      if (data.role === "super_admin") {
        badge = `<span style="margin-left: 4px; color: red; font-weight: bold;">👑</span>`;
      } else if (data.role === "admin") {
        badge = `<span style="margin-left: 4px; color: orange; font-weight: bold;">🎯</span>`;
      } else if (data.role === "guest") {
        badge = `<span style="margin-left: 4px; color: gray; font-weight: bold;">👀</span>`;
      }
      // 构建消息 HTML 内容
      msgDiv.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div style="flex: 1;">
          <span class="username" style="color:${nameColor}; font-weight:bold;cursor: pointer;" onclick="atUser('${data.username}')">${data.username}</span>${badge}: 
          ${highlightMentions(data.message)}
        </div>
        <span style="font-size:12px; color:#aaa; white-space: nowrap; margin-left: 8px;">${timeStr}</span>
      </div>
    `;
      // 插入到消息框中
      if (prepend) {
        chatBox.insertBefore(msgDiv, chatBox.firstChild);
      } else {
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }
      // 如果该消息是 @ 自己的，高亮提示
      highlightIfMentioned(msgDiv, data);
    }
    // 点击用户名时自动补齐 @用户名 到输入栏中
    function atUser(name) {
      const input = document.getElementById("message");
      const atText = `@${name} `;

      // 如果已经包含，不重复添加@信息
      if (!input.value.includes(atText)) {
        const span = document.createElement("span");
        span.style.color = "#f472b6"; // 粉色
        span.textContent = atText;
        input.value += input.value ? ` ${atText}` : atText;
        input.focus();
      }
    }

    // 发送当前输入栏的消息
    function sendMessage() {
      const msg = messageInput.value.trim();
      if (!msg) return;
      socket.emit("send_message", { message: msg });
      messageInput.value = "";
    }

    // 退出登录，清除缓存，跳转 logout
    function logout() {
      if (window.username === "游客") {
        localStorage.removeItem("savedUsername"); // 清除游客名
      }
      localStorage.removeItem("savedUsername");
      localStorage.removeItem("savedPassword");
      localStorage.setItem("autoLogin", "no");
      window.location.href = "/logout";
    }

    // 加载更多历史记录
    function loadMore() {
      socket.emit("load_more_history", {
        offset: messageOffset,
        limit: limitPerLoad,
      });
    }

    // 支持回车快速发送
    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    // 打开在线用户列表浮窗
    function openOnlineList() {
      document.getElementById("online-overlay").style.display = "block";
      document.getElementById("online-modal").style.display = "block";
      document.body.style.overflow = "hidden";
    }

    // 关闭在线用户列表浮窗
    function closeOnlineList() {
      document.getElementById("online-overlay").style.display = "none";
      document.getElementById("online-modal").style.display = "none";
      document.body.style.overflow = "";
    }

    // 检查是否需要展示公告栏
    function checkAnnouncement() {
      fetch('/announcement')
        .then(res => res.json())
        .then(data => {
          const savedId = localStorage.getItem("announcement_seen_id");
          if (savedId !== data.id) {
            document.getElementById("announcement-title").textContent = data.title;
            document.getElementById("announcement-content").textContent = data.content;
            document.getElementById("announcement-modal").style.display = "block";
            document.getElementById("announcement-overlay").style.display = "block"; // 显示遮罩
            document.body.style.overflow = "hidden"; // 禁止页面滚动
            window.currentAnnouncementId = data.id;
          }
        });
    }

    // 关闭公告栏
    function closeAnnouncement() {
      document.getElementById("announcement-modal").style.display = "none";
      document.getElementById("announcement-overlay").style.display = "none"; // 隐藏遮罩
      document.body.style.overflow = ""; // 恢复滚动
    }

    // 记录已阅读过该ID的公告栏信息
    function acknowledgeAnnouncement() {
      localStorage.setItem("announcement_seen_id", window.currentAnnouncementId);
      closeAnnouncement();
    }

    // 页面加载时检查公告 并检查身份 若是游客关闭输入栏发送消息的权限
    window.addEventListener("DOMContentLoaded", () => {
      checkAnnouncement();

      fetch("/usernames")
        .then(res => res.json())
        .then(names => {
          names.forEach(name => knownUsernames.add(name));
          initSocket(); // ← 加载完用户名后再连接 socket
        });

      const role = window.userRole;
      const nameEl = document.getElementById("username");
      const badgeEl = document.createElement("span");
      // 创建徽章块（包含表情 + 文字）
      badgeEl.style.marginLeft = "6px";
      badgeEl.style.lineHeight = "1";
      badgeEl.style.position = "relative";

      // 处理身份颜色和徽章
      if (role === "super_admin") {
        nameEl.style.color = "red";
        badgeEl.innerHTML = '<span style="font-size: 0.9em;">👑</span>';
      } else if (role === "admin") {
        nameEl.style.color = "orange";
        badgeEl.innerHTML = '<span style="font-size: 0.9em;">🎯</span>';
      } else if (role === "guest") {
        nameEl.style.color = "gray";
        badgeEl.innerHTML = '<span style="font-size: 0.9em;">👀</span>';
      }

      // 添加徽章到用户名后面
      nameEl.insertAdjacentElement("afterend", badgeEl);

      // 游客禁止发言逻辑
      if (role === "guest") {
        const input = document.getElementById("message");
        const button = document.querySelector("#chat-input button");

        input.disabled = true;
        input.placeholder = "游客无法发送消息";
        button.textContent = "注册";
        button.onclick = () => window.location.href = "/";
      }
    });

    // 注册 PWA Service Worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("/static/service-worker.js")
          .then((reg) => console.log("ServiceWorker 注册成功:", reg.scope))
          .catch((err) => console.log("ServiceWorker 注册失败:", err));
      });
    }
  </script>
</body>

</html>
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Finkçš„å°çª - èŠå¤©å°çª—</title>
  <meta name="description" content="Finkçš„å°çª - ä¸€ä¸ªæ¸©é¦¨å¯çˆ±çš„å®æ—¶èŠå¤©å°ç«™ï¼Œæ”¯æŒæ³¨å†Œã€ç™»å½•ã€æ¶ˆæ¯äº’åŠ¨ã€‚" />
  <!-- è®¾ç½®ç½‘é¡µå›¾æ ‡ï¼ˆfaviconï¼‰ -->
  <link rel="icon" href="/static/icon.ico" type="image/x-icon" />
  <!-- å¯é€‰ï¼šç¤¾äº¤åˆ†äº«å›¾æ ‡ï¼ˆOpen Graphï¼‰ -->
  <meta property="og:title" content="Finkçš„å°çª - èŠå¤©å°çª—" />
  <meta property="og:description" content="å’Œæœ‹å‹ä»¬ä¸€èµ·çªåœ¨è¿™é‡ŒèŠå¤©å§ï¼" />
  <meta property="og:image" content="/static/logo.webp" />
  <meta property="og:type" content="website" />
  <link rel="manifest" href="/static/manifest.json" />
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZK9F0GE4SE"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-ZK9F0GE4SE');
  </script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 0;
      height: 100vh;
      /* å æ»¡å…¨å± */
      overflow: hidden;
      /* é˜²æ­¢æ»šåŠ¨æ¡ */
    }

    .container {
      width: 100%;
      max-width: 580px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 20px 16px 12px;
      box-shadow: none;
      border-radius: 10px;
      background: white;
      display: flex;
      flex-direction: column;
    }

    h1 {
      text-align: center;
      margin: 0 0 10px;
      color: #333;
      font-size: 22px;
    }

    #top-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    #load-more {
      flex: 1;
      padding: 6px 12px;
      font-size: 13px;
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
    }

    #load-more:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    #logout {
      padding: 6px 7px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
    }

    #logout img {
      width: 18px;
      height: 18px;
      display: block;
    }

    #chat-box {
      flex: 1;
      overflow-y: auto;
      max-height: calc(100vh - 240px);
      /* ä¿è¯ chat-box ä¸è¢«æ’‘å‡ºå» */
      border: 1.5px solid #ccc;
      padding: 10px;
      background: #fafafa;
      border-radius: 6px;
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 8px;
      word-break: break-all;
    }

    #chat-input {
      display: flex;
      margin-bottom: 10px;
    }

    #chat-input input[type="text"] {
      flex: 1;
      padding: 10px;
      font-size: 14px;
      border: 1.5px solid #ccc;
      border-radius: 6px 0 0 6px;
      outline: none;
    }

    #chat-input button {
      padding: 10px 16px;
      background: #3b82f6;
      color: white;
      font-weight: 600;
      border: none;
      border-radius: 0 6px 6px 0;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #chat-input button:hover {
      background: #2563eb;
    }

    @media (max-width: 480px) {
      .container {
        height: 95vh;
        border-radius: 0;
        padding: 16px;
      }

      h1 {
        font-size: 18px;
      }

      #chat-box {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 8px;
      }
    }

    #footer {
      bottom: 0;
      left: 0;
      width: 100%;
      font-size: 13px;
      color: #888;
      background: #ffffff;
      text-align: center;
      padding: 12px 0;
      border-top: 1px solid #ffffff;
      z-index: 99;
    }

    #footer a {
      color: #3b82f6;
      text-decoration: none;
    }

    #footer a:hover {
      text-decoration: underline;
    }


    #announcement-modal button.confirm-btn {
      margin-top: 12px;
      padding: 6px 12px;
      border: none;
      background: #faad14;
      color: white;
      border-radius: 4px;
      font-size: 14px;
      width: 100%;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    #announcement-modal button.confirm-btn:hover {
      background: #d48806;
    }
  </style>
</head>

<body>
  <div class="container">



    <!-- å…¬å‘Šå¼¹çª— -->
    <!-- é®ç½©å±‚ -->
    <div id="announcement-overlay" style="display: none; position: fixed; top: 0; left: 0;
width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.3); z-index: 998;">
      <div id="announcement-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
         z-index: 999; background: #fffbe6; border: 1px solid #ffe58f;
         padding: 20px 16px; width: 90%; max-width: 400px; border-radius: 8px;
         box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);">

        <div style="display: flex; justify-content: space-between; align-items: start;">
          <div>
            <strong id="announcement-title" style="color: #f2ae26; font-size: 16px;"></strong>
            <p id="announcement-content" style="margin: 6px 0 0; color: #333; font-size: 14px;white-space: pre-line;">
            </p>
          </div>
          <button onclick="closeAnnouncement()"
            style="background: none; border: none; font-weight: bold; cursor: pointer; font-size: 16px;">âœ•</button>
        </div>

        <button onclick="acknowledgeAnnouncement()" class="confirm-btn">æˆ‘å·²çŸ¥æ™“</button>
      </div>
    </div>





    <h1>
      æ¬¢è¿
      <span id="username" style="font-weight: bold;">{{ username }}</span>
      æ¥åˆ°Finkçš„å°çª
    </h1>

    <div id="top-bar">
      <button id="load-more" onclick="loadMore()">åŠ è½½æ›´å¤šå†å²ä¿¡æ¯</button>
      <button id="logout" onclick="logout()">
        <img src="/static/logout.svg" alt="é€€å‡º" />
      </button>
    </div>

    <div id="chat-box"></div>
    <div id="chat-input">
      <input type="text" id="message" placeholder="è¾“å…¥æ¶ˆæ¯..." />
      <button onclick="sendMessage()">å‘é€</button>
    </div>

    <div id="footer">
      Â© 2025 Fink Â·
      <a href="https://github.com/finkkk/fink_chat" target="_blank">å¼€æºåœ°å€</a>
      Â· {{ version }} Â· æ›´æ–°:{{ updated }}
    </div>
  </div>

  <script>
    window.username = "{{ username }}";
    window.userRole = "{{ role }}";
    const username = "{{ username }}";
    const socket = io({ withCredentials: true });

    const chatBox = document.getElementById("chat-box");
    const messageInput = document.getElementById("message");
    const loadMoreBtn = document.getElementById("load-more");

    let messageOffset = 0;
    const limitPerLoad = 10;

    function appendMessage(data, prepend = false) {
      const msgDiv = document.createElement("div");

      // å°† ISO æ ¼å¼æ—¶é—´è½¬æ¢æˆæœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²
      let timeStr = "";
      if (data.timestamp) {
        try {
          const local = new Date(data.timestamp + "Z");
          timeStr = local.toLocaleString(undefined, {
            year: "numeric",
            month: "numeric",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
          });
        } catch { }
      }

      let nameColor = "#3b82f6";

      // å½“å‰ç”¨æˆ·è‡ªå·±æ˜¯è¶…çº§ç®¡ç†å‘˜ â†’ çº¢è‰²
      if (data.username === window.username && window.userRole === "super_admin") {
        nameColor = "red";
      }
      // å½“å‰ç”¨æˆ·è‡ªå·±æ˜¯ç®¡ç†å‘˜ â†’ æ©™è‰²
      else if (data.username === window.username && window.userRole === "admin") {
        nameColor = "orange";
      }
      
      // å¦‚æœå‘è¨€è€…æ˜¯è¶…çº§ç®¡ç†å‘˜ â†’ çº¢è‰²
      else if (data.role === "super_admin") {
        nameColor = "red";
      }
      // å¦‚æœå‘è¨€è€…æ˜¯ç®¡ç†å‘˜ â†’ æ©™è‰²
      else if (data.role === "admin") {
        nameColor = "orange";
      }

      // èº«ä»½å¾½ç« 
      let badge = "";
      if (data.role === "super_admin") {
        badge = `<span style="margin-left: 4px; color: red; font-weight: bold;">ğŸ‘‘</span>`;
      } else if (data.role === "admin") {
        badge = `<span style="margin-left: 4px; color: orange; font-weight: bold;">ğŸ¯</span>`;
      } else if (data.role === "guest") {
        badge = `<span style="margin-left: 4px; color: gray; font-weight: bold;">ğŸ‘€</span>`;
      }

      msgDiv.innerHTML = `
  <div style="display: flex; justify-content: space-between; align-items: flex-start;">
    <div style="flex: 1;">
      <span class="username" style="color:${nameColor}; font-weight:bold;">${data.username}</span>${badge}: 
      ${data.message}
    </div>
    <span style="font-size:12px; color:#aaa; white-space: nowrap; margin-left: 8px;">${timeStr}</span>
  </div>
`;

      if (prepend) {
        chatBox.insertBefore(msgDiv, chatBox.firstChild);
      } else {
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    }

    socket.on("connect", () => {
      console.log("å·²è¿æ¥åˆ°æœåŠ¡å™¨");
      socket.emit("bind_username", { username, role: window.userRole });
    });

    socket.on("chat_history", (messages) => {
      if (!messages || messages.length === 0) {
        loadMoreBtn.disabled = true;
        loadMoreBtn.textContent = "æ²¡æœ‰æ›´å¤šæ¶ˆæ¯";
        return;
      }

      messages.reverse().forEach((msg) => appendMessage(msg, true));
      messageOffset += messages.length;

      // é¦–æ¬¡è¿›å…¥è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
      if (messageOffset === messages.length) {
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    });

    socket.on("receive_message", (data) => {
      appendMessage(data);
    });

    function sendMessage() {
      const msg = messageInput.value.trim();
      if (!msg) return;
      socket.emit("send_message", { message: msg });
      messageInput.value = "";
    }

    function logout() {
      if (window.username === "æ¸¸å®¢") {
        localStorage.removeItem("savedUsername"); // æ¸…é™¤æ¸¸å®¢å
      }
      localStorage.removeItem("savedUsername");
      localStorage.removeItem("savedPassword");
      localStorage.setItem("autoLogin", "no");
      window.location.href = "/logout";
    }

    function loadMore() {
      socket.emit("load_more_history", {
        offset: messageOffset,
        limit: limitPerLoad,
      });
    }

    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("/static/service-worker.js")
          .then((reg) => console.log("ServiceWorker æ³¨å†ŒæˆåŠŸ:", reg.scope))
          .catch((err) => console.log("ServiceWorker æ³¨å†Œå¤±è´¥:", err));
      });
    }




    function checkAnnouncement() {
      fetch('/announcement')
        .then(res => res.json())
        .then(data => {
          const savedId = localStorage.getItem("announcement_seen_id");
          if (savedId !== data.id) {
            document.getElementById("announcement-title").textContent = data.title;
            document.getElementById("announcement-content").textContent = data.content;
            document.getElementById("announcement-modal").style.display = "block";
            document.getElementById("announcement-overlay").style.display = "block"; // æ˜¾ç¤ºé®ç½©
            document.body.style.overflow = "hidden"; // ç¦æ­¢é¡µé¢æ»šåŠ¨
            window.currentAnnouncementId = data.id;
          }
        });
    }

    function closeAnnouncement() {
      document.getElementById("announcement-modal").style.display = "none";
      document.getElementById("announcement-overlay").style.display = "none"; // éšè—é®ç½©
      document.body.style.overflow = ""; // æ¢å¤æ»šåŠ¨
    }

    function acknowledgeAnnouncement() {
      localStorage.setItem("announcement_seen_id", window.currentAnnouncementId);
      closeAnnouncement();
    }


    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å…¬å‘Š å¹¶æ£€æŸ¥èº«ä»½ è‹¥æ˜¯æ¸¸å®¢å…³é—­è¾“å…¥æ å‘é€æ¶ˆæ¯çš„æƒé™
    window.addEventListener("DOMContentLoaded", () => {
      checkAnnouncement();

      const role = window.userRole;
      const nameEl = document.getElementById("username");
      const badgeEl = document.createElement("span");
      // åˆ›å»ºå¾½ç« å—ï¼ˆåŒ…å«è¡¨æƒ… + æ–‡å­—ï¼‰
      badgeEl.style.marginLeft = "6px";
      badgeEl.style.lineHeight = "1";
      badgeEl.style.position = "relative";

      // å¤„ç†èº«ä»½é¢œè‰²å’Œå¾½ç« 
      if (role === "super_admin") {
        nameEl.style.color = "red";
        badgeEl.innerHTML = '<span style="font-size: 0.9em;">ğŸ‘‘</span>';
      } else if (role === "admin") {
        nameEl.style.color = "orange";
        badgeEl.innerHTML = '<span style="font-size: 0.9em;">ğŸ¯</span>';
      } else if (role === "guest") {
        nameEl.style.color = "gray";
        badgeEl.innerHTML = '<span style="font-size: 0.9em;">ğŸ‘€</span>';
      }

      // æ·»åŠ å¾½ç« åˆ°ç”¨æˆ·ååé¢
      nameEl.insertAdjacentElement("afterend", badgeEl);

      // æ¸¸å®¢ç¦æ­¢å‘è¨€é€»è¾‘
      if (role === "guest") {
        const input = document.getElementById("message");
        const button = document.querySelector("#chat-input button");

        input.disabled = true;
        input.placeholder = "æ¸¸å®¢æ— æ³•å‘é€æ¶ˆæ¯";
        button.textContent = "æ³¨å†Œ";
        button.onclick = () => window.location.href = "/";
      }
    });
  </script>
</body>

</html>